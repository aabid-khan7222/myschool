import { useEffect, useState, useRef } from "react";
import { Link, useNavigate, useParams } from "react-router-dom";
// import { feeGroup, feesTypes, paymentType } from '../../../core/common/selectoption/selectoption'
import { DatePicker } from "antd";
import dayjs from "dayjs";
import { all_routes } from "../../../router/all_routes";
import {
  AdmissionNo,
  PickupPoint,
  VehicleNumber,
  allClass,
  gender,
  names,
  rollno,
  route,
  status,
} from "../../../../core/common/selectoption/selectoption";

import CommonSelect from "../../../../core/common/commonSelect";
import { useLocation } from "react-router-dom";
import TagInput from "../../../../core/common/Taginput";
import { useAcademicYears } from "../../../../core/hooks/useAcademicYears";
import { useClasses } from "../../../../core/hooks/useClasses";
import { useSections } from "../../../../core/hooks/useSections";
import { useBloodGroups } from "../../../../core/hooks/useBloodGroups";
import { useReligions } from "../../../../core/hooks/useReligions";
import { useCasts } from "../../../../core/hooks/useCasts";
import { useMotherTongues } from "../../../../core/hooks/useMotherTongues";
import { useHouses } from "../../../../core/hooks/useHouses";
import { useHostels } from "../../../../core/hooks/useHostels";
import { useHostelRooms } from "../../../../core/hooks/useHostelRooms";
import { apiService } from "../../../../core/services/apiService";

// Lookup item types (hooks are JS and return untyped arrays)
interface AcademicYearItem {
  id: number;
  year_name?: string;
  is_current?: boolean;
}
interface ClassItem {
  id: number;
  class_name?: string;
}
interface SectionItem {
  id: number;
  section_name?: string;
}
interface BloodGroupItem {
  id: number;
  blood_group?: string;
}
interface HouseItem {
  id: number;
  house_name?: string;
}
interface ReligionItem {
  id: number;
  religion_name?: string;
}
interface CastItem {
  id: number;
  cast_name?: string;
}
interface MotherTongueItem {
  id: number;
  language_name?: string;
}

const AddStudent = () => {
  const routes = all_routes;
  const navigate = useNavigate();
  const { id } = useParams<{ id: string }>();

  const [isEdit, setIsEdit] = useState<boolean>(false);
  const [isSubmitting, setIsSubmitting] = useState<boolean>(false);
  const [submitError, setSubmitError] = useState<string | null>(null);
  const [studentData, setStudentData] = useState<any>(null);
  const [loadingStudent, setLoadingStudent] = useState<boolean>(false);
  const fetchedStudentIdRef = useRef<string | null>(null); // Track which student ID we've fetched
  
  // Form state for Personal Information section
  const [formData, setFormData] = useState<{
    academic_year_id: string | null;
    admission_number: string;
    admission_date: dayjs.Dayjs | null;
    roll_number: string;
    status: string;
    first_name: string;
    last_name: string;
    class_id: string | null;
    section_id: string | null;
    gender: string;
    date_of_birth: dayjs.Dayjs | null;
    blood_group_id: string | null;
    house_id: string | null;
    religion_id: string | null;
    cast_id: string | null;
    phone: string;
    email: string;
    mother_tongue_id: string | null;
    current_address: string;
    permanent_address: string;
    father_name: string;
    father_email: string;
    father_phone: string;
    father_occupation: string;
    father_image_url: string;
    mother_name: string;
    mother_email: string;
    mother_phone: string;
    mother_occupation: string;
    mother_image_url: string;
    // Guardian
    guardian_first_name: string;
    guardian_last_name: string;
    guardian_relation: string;
    guardian_phone: string;
    guardian_email: string;
    guardian_occupation: string;
    guardian_address: string;
    // Siblings (API uses sibiling_1, sibiling_2, sibiling_1_class, sibiling_2_class)
    sibiling_1: string;
    sibiling_2: string;
    sibiling_1_class: string;
    sibiling_2_class: string;
    // Transport
    is_transport_required: boolean;
    route_id: string | null;
    pickup_point_id: string | null;
    route_name: string;
    pickup_point_name: string;
    vehicle_number: string;
    // Hostel
    is_hostel_required: boolean;
    hostel_id: string | null;
    hostel_room_id: string | null;
    hostel_name: string;
    hostel_room_number: string;
    // Medical
    medical_condition: string;
    // Previous school
    previous_school: string;
    previous_school_address: string;
    // Other / Bank
    bank_name: string;
    branch: string;
    ifsc: string;
    other_information: string;
  }>({
    academic_year_id: null,
    admission_number: '',
    admission_date: null,
    roll_number: '',
    status: 'Active',
    first_name: '',
    last_name: '',
    class_id: null,
    section_id: null,
    gender: '',
    date_of_birth: null,
    blood_group_id: null,
    house_id: null,
    religion_id: null,
    cast_id: null,
    phone: '',
    email: '',
    mother_tongue_id: null,
    current_address: '',
    permanent_address: '',
    father_name: '',
    father_email: '',
    father_phone: '',
    father_occupation: '',
    father_image_url: '',
    mother_name: '',
    mother_email: '',
    mother_phone: '',
    mother_occupation: '',
    mother_image_url: '',
    guardian_first_name: '',
    guardian_last_name: '',
    guardian_relation: '',
    guardian_phone: '',
    guardian_email: '',
    guardian_occupation: '',
    guardian_address: '',
    sibiling_1: '',
    sibiling_2: '',
    sibiling_1_class: '',
    sibiling_2_class: '',
    is_transport_required: false,
    route_id: null,
    pickup_point_id: null,
    route_name: '',
    pickup_point_name: '',
    vehicle_number: '',
    is_hostel_required: false,
    hostel_id: null,
    hostel_room_id: null,
    hostel_name: '',
    hostel_room_number: '',
    medical_condition: 'Good',
    previous_school: '',
    previous_school_address: '',
    bank_name: '',
    branch: '',
    ifsc: '',
    other_information: ''
  });
  
  // Fetch academic years from API
  const { academicYears, loading: academicYearsLoading, error: academicYearsError } = useAcademicYears();
  
  // Fetch classes from API
  const { classes, loading: classesLoading, error: classesError } = useClasses();
  
  // Fetch sections from API
  const { sections, loading: sectionsLoading, error: sectionsError } = useSections();
  
  // Fetch blood groups from API
  const { bloodGroups, loading: bloodGroupsLoading, error: bloodGroupsError } = useBloodGroups();
  
  // Fetch religions from API
  const { religions, loading: religionsLoading, error: religionsError } = useReligions();
  
  // Fetch casts from API
  const { casts, loading: castsLoading, error: castsError } = useCasts();
  
  // Fetch mother tongues from API
  const { motherTongues, loading: motherTonguesLoading, error: motherTonguesError } = useMotherTongues();
  
  // Fetch houses from API
  const { houses, loading: housesLoading, error: housesError } = useHouses();

  // Fetch hostels and hostel rooms from API (for dropdowns with real IDs)
  const { hostels } = useHostels();
  const { hostelRooms } = useHostelRooms();
  const hostelOptions = (hostels || []).map((h: { originalData?: { id: number }; hostelName?: string }) => ({
    value: String((h.originalData as { id?: number })?.id ?? ""),
    label: (h.hostelName as string) || "N/A",
  })).filter((o: { value: string }) => o.value);
  const roomOptions = (hostelRooms || []).map((r: { originalData?: { id: number }; roomNo?: string }) => ({
    value: String((r.originalData as { id?: number })?.id ?? ""),
    label: (r.roomNo as string) || "N/A",
  })).filter((o: { value: string }) => o.value);

  // Typed lists (hooks are JS and return untyped arrays - avoid 'never' inference)
  const academicYearsList = (academicYears || []) as AcademicYearItem[];
  const classesList = (classes || []) as ClassItem[];
  const sectionsList = (sections || []) as SectionItem[];
  const bloodGroupsList = (bloodGroups || []) as BloodGroupItem[];
  const housesList = (houses || []) as HouseItem[];
  const religionsList = (religions || []) as ReligionItem[];
  const castsList = (casts || []) as CastItem[];
  const motherTonguesList = (motherTongues || []) as MotherTongueItem[];

  // Parse comma-separated or single string into array of non-empty trimmed strings
  const parseTagList = (val: unknown): string[] => {
    if (val == null || val === '') return [];
    if (Array.isArray(val)) return val.map(String).map(s => s.trim()).filter(Boolean);
    const s = String(val).trim();
    if (!s) return [];
    return s.split(',').map(part => part.trim()).filter(Boolean);
  };

  // Function to fetch student data for editing
  const fetchStudentData = async (studentId: string) => {
    // Prevent multiple simultaneous calls or re-fetching the same student
    if (loadingStudent) {
      console.log('Already loading student data, skipping duplicate call');
      return;
    }
    if (fetchedStudentIdRef.current === studentId && studentData) {
      console.log('Student data already fetched for ID:', studentId);
      return;
    }
    try {
      setLoadingStudent(true);
      fetchedStudentIdRef.current = studentId; // Mark as fetching
      const response = await apiService.getStudentById(studentId);
      console.log('Fetched student data:', response);
      setStudentData(response.data);
      
      const student = response.data;
      setFormData({
        academic_year_id: student.academic_year_id ? student.academic_year_id.toString() : null,
        admission_number: student.admission_number || '',
        admission_date: student.admission_date ? dayjs(student.admission_date) : null,
        roll_number: student.roll_number || '',
        status: student.is_active ? 'Active' : 'Inactive',
        first_name: student.first_name || '',
        last_name: student.last_name || '',
        class_id: student.class_id ? student.class_id.toString() : null,
        section_id: student.section_id ? student.section_id.toString() : null,
        gender: student.gender || '',
        date_of_birth: student.date_of_birth ? dayjs(student.date_of_birth) : null,
        blood_group_id: student.blood_group_id ? student.blood_group_id.toString() : null,
        house_id: student.house_id ? student.house_id.toString() : null,
        religion_id: student.religion_id ? student.religion_id.toString() : null,
        cast_id: student.cast_id ? student.cast_id.toString() : null,
        phone: student.phone || '',
        email: student.email || '',
        mother_tongue_id: student.mother_tongue_id ? student.mother_tongue_id.toString() : null,
        current_address: student.current_address || student.address || '',
        permanent_address: student.permanent_address || '',
        father_name: student.father_name || '',
        father_email: student.father_email || '',
        father_phone: student.father_phone || '',
        father_occupation: student.father_occupation || '',
        father_image_url: student.father_image_url || '',
        mother_name: student.mother_name || '',
        mother_email: student.mother_email || '',
        mother_phone: student.mother_phone || '',
        mother_occupation: student.mother_occupation || '',
        mother_image_url: student.mother_image_url || '',
        guardian_first_name: student.guardian_first_name || '',
        guardian_last_name: student.guardian_last_name || '',
        guardian_relation: student.guardian_relation || '',
        guardian_phone: student.guardian_phone || '',
        guardian_email: student.guardian_email || '',
        guardian_occupation: student.guardian_occupation || '',
        guardian_address: student.guardian_address || '',
        sibiling_1: student.sibiling_1 || '',
        sibiling_2: student.sibiling_2 || '',
        sibiling_1_class: student.sibiling_1_class || '',
        sibiling_2_class: student.sibiling_2_class || '',
        is_transport_required: !!student.is_transport_required,
        route_id: student.route_id != null ? student.route_id.toString() : null,
        pickup_point_id: student.pickup_point_id != null ? student.pickup_point_id.toString() : null,
        route_name: student.route_name || '',
        pickup_point_name: student.pickup_point_name || '',
        vehicle_number: student.vehicle_number || '',
        is_hostel_required: !!student.is_hostel_required,
        hostel_id: student.hostel_id != null ? student.hostel_id.toString() : null,
        hostel_room_id: student.hostel_room_id != null ? student.hostel_room_id.toString() : null,
        hostel_name: student.hostel_name || '',
        hostel_room_number: student.hostel_room_number != null ? String(student.hostel_room_number) : '',
        medical_condition: student.medical_condition || 'Good',
        previous_school: student.previous_school || '',
        previous_school_address: student.previous_school_address || '',
        bank_name: student.bank_name || student.bankName || '',
        branch: student.branch || student.branchName || '',
        ifsc: student.ifsc || student.ifscCode || '',
        other_information: student.other_information || ''
      });
      setOwner1(parseTagList(student.known_allergies ?? student.knownAllergies));
      setOwner2(parseTagList(student.medications ?? student.medicationsList));
    } catch (error: any) {
      console.error('Error fetching student data:', error);
      setSubmitError(error.message || 'Failed to fetch student data');
      fetchedStudentIdRef.current = null; // Reset on error so we can retry
    } finally {
      setLoadingStudent(false);
    }
  };

  // Effect to handle form data population when dropdown options are loaded
  // Use ref to track if we've already populated form data to prevent unnecessary updates
  const formDataPopulatedRef = useRef(false);
  useEffect(() => {
    if (studentData && isEdit && !formDataPopulatedRef.current) {
      // Only populate if dropdowns are loaded (non-empty arrays)
      const dropdownsReady = bloodGroups.length > 0 && religions.length > 0 && 
                            casts.length > 0 && motherTongues.length > 0 && houses.length > 0;
      
      if (dropdownsReady) {
        console.log('Student data available, populating form data...');
        const student = studentData;
        setFormData(prev => ({
          ...prev,
          blood_group_id: student.blood_group_id ? student.blood_group_id.toString() : null,
          house_id: student.house_id ? student.house_id.toString() : null,
          religion_id: student.religion_id ? student.religion_id.toString() : null,
          cast_id: student.cast_id ? student.cast_id.toString() : null,
          mother_tongue_id: student.mother_tongue_id ? student.mother_tongue_id.toString() : null,
          current_address: student.current_address || student.address || '',
          permanent_address: student.permanent_address || '',
        }));
        formDataPopulatedRef.current = true;
      }
    }
    // Reset ref when studentData changes (new student being edited)
    if (!studentData) {
      formDataPopulatedRef.current = false;
    }
  }, [studentData, bloodGroups.length, religions.length, casts.length, motherTongues.length, houses.length, isEdit]);

  // Set current academic year as default when loaded (only once, not on every formData change)
  const academicYearSetRef = useRef(false);
  useEffect(() => {
    if (academicYearsList.length > 0 && !formData.academic_year_id && !academicYearSetRef.current) {
      console.log('Academic years data:', academicYearsList);
      // Find the current academic year (where is_current = true)
      const currentAcademicYear = academicYearsList.find(year => year.is_current === true);

      if (currentAcademicYear) {
        console.log('Current academic year found:', currentAcademicYear);
        setFormData(prev => ({
          ...prev,
          academic_year_id: currentAcademicYear.id.toString()
        }));
      } else {
        console.log('No current academic year found, using first one:', academicYearsList[0]);
        // Fallback to the first academic year if no current year is found
        setFormData(prev => ({
          ...prev,
          academic_year_id: academicYearsList[0].id.toString()
        }));
      }
      academicYearSetRef.current = true;
    }
    // Reset ref when academic years change (new data loaded)
    if (academicYearsList.length === 0) {
      academicYearSetRef.current = false;
    }
  }, [academicYearsList.length, formData.academic_year_id]);

  const [owner, setOwner] = useState<string[]>(["English", "Spanish"]);
  const handleTagsChange2 = (newTags: string[]) => {
    setOwner(newTags);
  };

  const [owner1, setOwner1] = useState<string[]>([]);
  const handleTagsChange3 = (newTags: string[]) => {
    setOwner1(newTags);
  };
  const [owner2, setOwner2] = useState<string[]>([]);
  const handleTagsChange4 = (newTags: string[]) => {
    setOwner2(newTags);
  };
  const [defaultDate, setDefaultDate] = useState<dayjs.Dayjs | null>(null);
  const [newContents, setNewContents] = useState<number[]>([0]);
  const location = useLocation();
  const addNewContent = () => {
    setNewContents([...newContents, newContents.length]);
  };
  const removeContent = (index: any) => {
    setNewContents(newContents.filter((_, i) => i !== index));
  };

  // Handle form field changes
  const handleInputChange = (field: string, value: any) => {
    console.log(`handleInputChange - Field: ${field}, Value:`, value, 'Type:', typeof value);
    setFormData(prev => {
      const newData = {
        ...prev,
        [field]: value
      };
      console.log(`Updated form data for ${field}:`, newData);
      return newData;
    });
  };

  // Handle form submission
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSubmitting(true);
    setSubmitError(null);

    try {
      // Debug: Log the raw form data
      console.log('Raw form data before processing:', formData);
      
      // Prepare data for submission
      const submitData = {
        ...formData,
        admission_date: formData.admission_date ? dayjs(formData.admission_date).format('YYYY-MM-DD') : null,
        date_of_birth: formData.date_of_birth ? dayjs(formData.date_of_birth).format('YYYY-MM-DD') : null,
        academic_year_id: formData.academic_year_id ? (typeof formData.academic_year_id === 'string' ? parseInt(formData.academic_year_id) : formData.academic_year_id) : null,
        class_id: formData.class_id ? (typeof formData.class_id === 'string' ? parseInt(formData.class_id) : formData.class_id) : null,
        section_id: formData.section_id ? (typeof formData.section_id === 'string' ? parseInt(formData.section_id) : formData.section_id) : null,
        blood_group_id: formData.blood_group_id ? (typeof formData.blood_group_id === 'string' ? parseInt(formData.blood_group_id) : formData.blood_group_id) : null,
        house_id: formData.house_id ? (typeof formData.house_id === 'string' ? parseInt(formData.house_id) : formData.house_id) : null,
        religion_id: formData.religion_id ? (typeof formData.religion_id === 'string' ? parseInt(formData.religion_id) : formData.religion_id) : null,
        cast_id: formData.cast_id ? (typeof formData.cast_id === 'string' ? parseInt(formData.cast_id) : formData.cast_id) : null,
        mother_tongue_id: formData.mother_tongue_id ? (typeof formData.mother_tongue_id === 'string' ? parseInt(formData.mother_tongue_id) : formData.mother_tongue_id) : null,
        // Gender should be stored as text, not converted to integer
        gender: formData.gender || null,
        // Parent fields
        father_name: formData.father_name || null,
        father_email: formData.father_email || null,
        father_phone: formData.father_phone || null,
        father_occupation: formData.father_occupation || null,
        father_image_url: formData.father_image_url || null,
        mother_name: formData.mother_name || null,
        mother_email: formData.mother_email || null,
        mother_phone: formData.mother_phone || null,
        mother_occupation: formData.mother_occupation || null,
        mother_image_url: formData.mother_image_url || null,
        // Guardian, address, siblings, transport, hostel, bank, medical
        guardian_first_name: formData.guardian_first_name || null,
        guardian_last_name: formData.guardian_last_name || null,
        guardian_relation: formData.guardian_relation || null,
        guardian_phone: formData.guardian_phone || null,
        guardian_email: formData.guardian_email || null,
        guardian_occupation: formData.guardian_occupation || null,
        guardian_address: formData.guardian_address || null,
        current_address: formData.current_address || null,
        previous_school: formData.previous_school || null,
        sibiling_1: formData.sibiling_1 || null,
        sibiling_2: formData.sibiling_2 || null,
        sibiling_1_class: formData.sibiling_1_class || null,
        sibiling_2_class: formData.sibiling_2_class || null,
        is_transport_required: formData.is_transport_required || false,
        route_id: formData.route_id ? (typeof formData.route_id === 'string' ? parseInt(formData.route_id) : formData.route_id) : null,
        pickup_point_id: formData.pickup_point_id ? (typeof formData.pickup_point_id === 'string' ? parseInt(formData.pickup_point_id) : formData.pickup_point_id) : null,
        is_hostel_required: formData.is_hostel_required || false,
        hostel_id: formData.hostel_id ? (typeof formData.hostel_id === 'string' ? parseInt(formData.hostel_id) : formData.hostel_id) : null,
        hostel_room_id: formData.hostel_room_id ? (typeof formData.hostel_room_id === 'string' ? parseInt(formData.hostel_room_id) : formData.hostel_room_id) : null,
        bank_name: formData.bank_name || null,
        branch: formData.branch || null,
        ifsc: formData.ifsc || null,
        known_allergies: Array.isArray(owner1) ? owner1 : (owner1 ? String(owner1).split(',').map(s => s.trim()).filter(Boolean) : []),
        medications: Array.isArray(owner2) ? owner2 : (owner2 ? String(owner2).split(',').map(s => s.trim()).filter(Boolean) : [])
      };

      // Debug: Log the processed submit data
      console.log('Processed submit data:', submitData);
      console.log('ID fields debug:', {
        academic_year_id: formData.academic_year_id,
        class_id: formData.class_id,
        section_id: formData.section_id,
        blood_group_id: formData.blood_group_id,
        house_id: formData.house_id,
        religion_id: formData.religion_id,
        cast_id: formData.cast_id,
        mother_tongue_id: formData.mother_tongue_id
      });
      
      let response;
      if (isEdit && id) {
        // Update existing student
        response = await apiService.updateStudent(id, submitData);
        console.log('Student updated successfully:', response);
      } else {
        // Create new student
        response = await apiService.createStudent(submitData);
        console.log('Student created successfully:', response);
      }
      
      // Navigate to student list on success
      navigate(routes.studentList);
    } catch (error: any) {
      console.error('Error saving student:', error);
      setSubmitError(error.message || `Failed to ${isEdit ? 'update' : 'create'} student`);
    } finally {
      setIsSubmitting(false);
    }
  };

  useEffect(() => {
    // Check if we're in edit mode by looking for the ID parameter
    const isEditMode = !!id;
    
    if (isEditMode) {
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, "0"); // Month is zero-based, so we add 1
      const day = String(today.getDate()).padStart(2, "0");
      const formattedDate = `${month}-${day}-${year}`;
      const defaultValue = dayjs(formattedDate);
      setIsEdit(true);
      setOwner(["English"]);
      // owner1/owner2 (allergies, medications) are set from API in fetchStudentData when editing
      setDefaultDate(defaultValue);
      console.log('Edit mode detected, formattedDate:', formattedDate);
      
      // Fetch student data if ID is available and not already loaded for this ID
      if (id && fetchedStudentIdRef.current !== id && !loadingStudent) {
        console.log('Fetching student data for ID:', id);
        fetchStudentData(id);
      } else if (id && fetchedStudentIdRef.current === id) {
        console.log('Student data already fetched for ID:', id);
      } else if (!id) {
        console.log('No student ID provided for edit mode');
        setSubmitError('No student ID provided for editing');
      }
    } else {
      setIsEdit(false);
      setDefaultDate(null);
      fetchedStudentIdRef.current = null; // Reset when not in edit mode
    }
  }, [id]); // Only depend on id to avoid unnecessary re-runs

  return (
    <>
      {/* Page Wrapper */}
      <div className="page-wrapper">
        <div className="content content-two">
          {/* Page Header */}
          <div className="d-md-flex d-block align-items-center justify-content-between mb-3">
            <div className="my-auto mb-2">
              <Link
                to={id ? `${routes.studentDetail}` : routes.studentList}
                state={id ? { studentId: id } : undefined}
                className="btn btn-outline-secondary mb-2 d-inline-flex align-items-center"
              >
                <i className="ti ti-arrow-left me-1" />
                Back
              </Link>
              <h3 className="mb-1">{isEdit ? "Edit" : "Add"} Student</h3>
              <nav>
                <ol className="breadcrumb mb-0">
                  <li className="breadcrumb-item">
                    <Link to={routes.adminDashboard}>Dashboard</Link>
                  </li>
                  <li className="breadcrumb-item">
                    <Link to={routes.studentList}>Students</Link>
                  </li>
                  <li className="breadcrumb-item active" aria-current="page">
                    {isEdit ? "Edit" : "Add"} Student
                  </li>
                </ol>
              </nav>
            </div>
          </div>
          {/* /Page Header */}
          {submitError && (
            <div className="alert alert-danger alert-dismissible fade show" role="alert">
              <i className="ti ti-alert-circle me-2"></i>
              {submitError}
              <button type="button" className="btn-close" onClick={() => setSubmitError(null)}></button>
            </div>
          )}
          {loadingStudent && (
            <div className="text-center p-4">
              <div className="spinner-border text-primary" role="status">
                <span className="visually-hidden">Loading...</span>
              </div>
              <p className="mt-2">Loading student data...</p>
            </div>
          )}
          {!loadingStudent && (
          <div className="row">
            <div className="col-md-12">
              <form onSubmit={handleSubmit}>
                {/* Personal Information */}
                <div className="card">
                  <div className="card-header bg-light">
                    <div className="d-flex align-items-center">
                      <span className="bg-white avatar avatar-sm me-2 text-gray-7 flex-shrink-0">
                        <i className="ti ti-info-square-rounded fs-16" />
                      </span>
                      <h4 className="text-dark">Personal Information</h4>
                    </div>
                  </div>
                  <div className="card-body pb-1">
                    <div className="row">
                      <div className="col-md-12">
                        <div className="d-flex align-items-center flex-wrap row-gap-3 mb-3">
                          <div className="d-flex align-items-center justify-content-center avatar avatar-xxl border border-dashed me-2 flex-shrink-0 text-dark frames">
                            <i className="ti ti-photo-plus fs-16" />
                          </div>
                          <div className="profile-upload">
                            <div className="profile-uploader d-flex align-items-center">
                              <div className="drag-upload-btn mb-3">
                                Upload
                                <input
                                  type="file"
                                  className="form-control image-sign"
                                  multiple
                                />
                              </div>
                              <Link to="#" className="btn btn-primary mb-3">
                                Remove
                              </Link>
                            </div>
                            <p className="fs-12">
                              Upload image size 4MB, Format JPG, PNG, SVG
                            </p>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div className="row row-cols-xxl-5 row-cols-md-6">
                      <div className="col-xxl col-xl-3 col-md-6">
                        <div className="mb-3">
                          <label className="form-label">Academic Year</label>
                          {academicYearsLoading ? (
                            <div className="form-control">
                              <i className="ti ti-loader ti-spin me-2"></i>
                              Loading academic years...
                            </div>
                          ) : academicYearsError ? (
                            <div className="form-control text-danger">
                              <i className="ti ti-alert-circle me-2"></i>
                              Error: {academicYearsError}
                            </div>
                          ) : (
                            <CommonSelect
                              className="select"
                              options={academicYearsList.map(year => ({
                                value: year.id.toString(),
                                label: year.year_name ?? ''
                              }))}
                              value={formData.academic_year_id}
                              onChange={(value) => handleInputChange('academic_year_id', value)}
                            />
                          )}
                        </div>
                      </div>
                      <div className="col-xxl col-xl-3 col-md-6">
                        <div className="mb-3">
                          <label className="form-label">Admission Number</label>
                          <input
                            type="text"
                            className="form-control"
                            value={formData.admission_number}
                            onChange={(e) => handleInputChange('admission_number', e.target.value)}
                            required
                          />
                        </div>
                      </div>
                      <div className="col-xxl col-xl-3 col-md-6">
                        <div className="mb-3">
                          <label className="form-label">Admission Date</label>
                          <div className="input-icon position-relative">
                            <DatePicker
                              className="form-control datetimepicker"
                              format={{
                                format: "DD-MM-YYYY",
                                type: "mask",
                              }}
                              value={formData.admission_date}
                              onChange={(date) => handleInputChange('admission_date', date)}
                              placeholder="Select Date"
                            />
                            <span className="input-icon-addon">
                              <i className="ti ti-calendar" />
                            </span>
                          </div>
                        </div>
                      </div>
                      <div className="col-xxl col-xl-3 col-md-6">
                        <div className="mb-3">
                          <label className="form-label">Roll Number</label>
                          <input
                            type="text"
                            className="form-control"
                            value={formData.roll_number}
                            onChange={(e) => handleInputChange('roll_number', e.target.value)}
                          />
                        </div>
                      </div>
                      <div className="col-xxl col-xl-3 col-md-6">
                        <div className="mb-3">
                          <label className="form-label">Status</label>
                          <CommonSelect
                            className="select"
                            options={status}
                            value={formData.status}
                            onChange={(value) => handleInputChange('status', value)}
                          />
                        </div>
                      </div>
                      <div className="col-xxl col-xl-3 col-md-6">
                        <div className="mb-3">
                          <label className="form-label">First Name</label>
                          <input
                            type="text"
                            className="form-control"
                            value={formData.first_name}
                            onChange={(e) => handleInputChange('first_name', e.target.value)}
                            required
                          />
                        </div>
                      </div>
                      <div className="col-xxl col-xl-3 col-md-6">
                        <div className="mb-3">
                          <label className="form-label">Last Name</label>
                          <input
                            type="text"
                            className="form-control"
                            value={formData.last_name}
                            onChange={(e) => handleInputChange('last_name', e.target.value)}
                            required
                          />
                        </div>
                      </div>
                      <div className="col-xxl col-xl-3 col-md-6">
                        <div className="mb-3">
                          <label className="form-label">Class</label>
                          {classesLoading ? (
                            <div className="form-control">
                              <i className="ti ti-loader ti-spin me-2"></i>
                              Loading classes...
                            </div>
                          ) : classesError ? (
                            <div className="form-control text-danger">
                              <i className="ti ti-alert-circle me-2"></i>
                              Error: {classesError}
                            </div>
                          ) : (
                            <CommonSelect
                              className="select"
                              options={classesList.map(cls => ({
                                value: cls.id.toString(),
                                label: cls.class_name ?? ''
                              }))}
                              value={formData.class_id}
                              onChange={(value) => handleInputChange('class_id', value)}
                            />
                          )}
                        </div>
                      </div>
                      <div className="col-xxl col-xl-3 col-md-6">
                        <div className="mb-3">
                          <label className="form-label">Section</label>
                          {sectionsLoading ? (
                            <div className="form-control">
                              <i className="ti ti-loader ti-spin me-2"></i>
                              Loading sections...
                            </div>
                          ) : sectionsError ? (
                            <div className="form-control text-danger">
                              <i className="ti ti-alert-circle me-2"></i>
                              Error: {sectionsError}
                            </div>
                          ) : (
                            <CommonSelect
                              className="select"
                              options={sectionsList.map(section => ({
                                value: section.id.toString(),
                                label: section.section_name ?? ''
                              }))}
                              value={formData.section_id}
                              onChange={(value) => handleInputChange('section_id', value)}
                            />
                          )}
                        </div>
                      </div>
                      <div className="col-xxl col-xl-3 col-md-6">
                        <div className="mb-3">
                          <label className="form-label">Gender</label>
                          <CommonSelect
                            className="select"
                            options={gender}
                            value={formData.gender}
                            onChange={(value) => handleInputChange('gender', value)}
                          />
                        </div>
                      </div>
                      <div className="col-xxl col-xl-3 col-md-6">
                        <div className="mb-3">
                          <label className="form-label">Date of Birth</label>
                          <div className="input-icon position-relative">
                            <DatePicker
                              className="form-control datetimepicker"
                              format={{
                                format: "DD-MM-YYYY",
                                type: "mask",
                              }}
                              value={formData.date_of_birth}
                              onChange={(date) => handleInputChange('date_of_birth', date)}
                              placeholder="Select Date"
                            />
                            <span className="input-icon-addon">
                              <i className="ti ti-calendar" />
                            </span>
                          </div>
                        </div>
                      </div>
                      <div className="col-xxl col-xl-3 col-md-6">
                        <div className="mb-3">
                          <label className="form-label">Blood Group</label>
                          {bloodGroupsLoading ? (
                            <div className="form-control">
                              <i className="ti ti-loader ti-spin me-2"></i>
                              Loading blood groups...
                            </div>
                          ) : bloodGroupsError ? (
                            <div className="form-control text-danger">
                              <i className="ti ti-alert-circle me-2"></i>
                              Error: {bloodGroupsError}
                            </div>
                          ) : (
                            <CommonSelect
                              className="select"
                              options={bloodGroupsList.map(bg => ({
                                value: bg.id.toString(),
                                label: bg.blood_group ?? ''
                              }))}
                              value={formData.blood_group_id}
                              onChange={(value) => handleInputChange('blood_group_id', value)}
                            />
                          )}
                        </div>
                      </div>
                      <div className="col-xxl col-xl-3 col-md-6">
                        <div className="mb-3">
                          <label className="form-label">House</label>
                          {housesLoading ? (
                            <div className="form-control">
                              <i className="ti ti-loader ti-spin me-2"></i>
                              Loading houses...
                            </div>
                          ) : housesError ? (
                            <div className="form-control text-danger">
                              <i className="ti ti-alert-circle me-2"></i>
                              Error: {housesError}
                            </div>
                          ) : (
                            <CommonSelect
                              className="select"
                              options={housesList.map(h => ({
                                value: h.id.toString(),
                                label: h.house_name ?? ''
                              }))}
                              value={formData.house_id}
                              onChange={(value) => handleInputChange('house_id', value)}
                            />
                          )}
                        </div>
                      </div>
                      <div className="col-xxl col-xl-3 col-md-6">
                        <div className="mb-3">
                          <label className="form-label">Religion</label>
                          {religionsLoading ? (
                            <div className="form-control">
                              <i className="ti ti-loader ti-spin me-2"></i>
                              Loading religions...
                            </div>
                          ) : religionsError ? (
                            <div className="form-control text-danger">
                              <i className="ti ti-alert-circle me-2"></i>
                              Error: {religionsError}
                            </div>
                          ) : (
                            <CommonSelect
                              className="select"
                              options={religionsList.map(religion => ({
                                value: religion.id.toString(),
                                label: religion.religion_name ?? ''
                              }))}
                              value={formData.religion_id}
                              onChange={(value) => handleInputChange('religion_id', value)}
                            />
                          )}
                        </div>
                      </div>
                      <div className="col-xxl col-xl-3 col-md-6">
                        <div className="mb-3">
                          <label className="form-label">Category</label>
                          {castsLoading ? (
                            <div className="form-control">
                              <i className="ti ti-loader ti-spin me-2"></i>
                              Loading categories...
                            </div>
                          ) : castsError ? (
                            <div className="form-control text-danger">
                              <i className="ti ti-alert-circle me-2"></i>
                              Error: {castsError}
                            </div>
                          ) : (
                            <CommonSelect
                              className="select"
                              options={castsList.map(cast => ({
                                value: cast.id.toString(),
                                label: cast.cast_name ?? ''
                              }))}
                              value={formData.cast_id}
                              onChange={(value) => handleInputChange('cast_id', value)}
                            />
                          )}
                        </div>
                      </div>
                      <div className="col-xxl col-xl-3 col-md-6">
                        <div className="mb-3">
                          <label className="form-label">
                            Primary Contact Number
                          </label>
                          <input
                            type="text"
                            className="form-control"
                            value={formData.phone}
                            onChange={(e) => handleInputChange('phone', e.target.value)}
                          />
                        </div>
                      </div>
                      <div className="col-xxl col-xl-3 col-md-6">
                        <div className="mb-3">
                          <label className="form-label">Email Address</label>
                          <input
                            type="email"
                            className="form-control"
                            value={formData.email}
                            onChange={(e) => handleInputChange('email', e.target.value)}
                          />
                        </div>
                      </div>
                      <div className="col-xxl col-xl-3 col-md-6">
                        <div className="mb-3">
                          <label className="form-label">Mother Tongue</label>
                          {motherTonguesLoading ? (
                            <div className="form-control">
                              <i className="ti ti-loader ti-spin me-2"></i>
                              Loading mother tongues...
                            </div>
                          ) : motherTonguesError ? (
                            <div className="form-control text-danger">
                              <i className="ti ti-alert-circle me-2"></i>
                              Error: {motherTonguesError}
                            </div>
                          ) : (
                            <CommonSelect
                              className="select"
                              options={motherTonguesList.map(mt => ({
                                value: mt.id.toString(),
                                label: mt.language_name ?? ''
                              }))}
                              value={formData.mother_tongue_id}
                              onChange={(value) => handleInputChange('mother_tongue_id', value)}
                            />
                          )}
                        </div>
                      </div>
                      <div className="col-xxl col-xl-3 col-md-6">
                        <div className="mb-3">
                          <label className="form-label">Language Known</label>
                          <TagInput
                           initialTags ={owner}
                            onTagsChange={handleTagsChange2}
                          />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                {/* /Personal Information */}
                {/* Parents & Guardian Information */}
                <div className="card">
                  <div className="card-header bg-light">
                    <div className="d-flex align-items-center">
                      <span className="bg-white avatar avatar-sm me-2 text-gray-7 flex-shrink-0">
                        <i className="ti ti-user-shield fs-16" />
                      </span>
                      <h4 className="text-dark">
                        Parents &amp; Guardian Information
                      </h4>
                    </div>
                  </div>
                  <div className="card-body pb-0">
                    <div className="border-bottom mb-3">
                      <h5 className="mb-3">Fatherâ€™s Info</h5>
                      <div className="row">
                        <div className="col-md-12">
                          <div className="d-flex align-items-center flex-wrap row-gap-3 mb-3">
                            <div className="d-flex align-items-center justify-content-center avatar avatar-xxl border border-dashed me-2 flex-shrink-0 text-dark frames">
                              <i className="ti ti-photo-plus fs-16" />
                            </div>
                            <div className="profile-upload">
                              <div className="profile-uploader d-flex align-items-center">
                                <div className="drag-upload-btn mb-3">
                                  Upload
                                  <input
                                    type="file"
                                    className="form-control image-sign"
                                    multiple
                                  />
                                </div>
                                <Link to="#" className="btn btn-primary mb-3">
                                  Remove
                                </Link>
                              </div>
                              <p className="fs-12">
                                Upload image size 4MB, Format JPG, PNG, SVG
                              </p>
                            </div>
                          </div>
                        </div>
                        <div className="col-lg-3 col-md-6">
                          <div className="mb-3">
                            <label className="form-label">Father Name</label>
                            <input
                              type="text"
                              className="form-control"
                              value={formData.father_name}
                              onChange={(e) => handleInputChange('father_name', e.target.value)}
                            />
                          </div>
                        </div>
                        <div className="col-lg-3 col-md-6">
                          <div className="mb-3">
                            <label className="form-label">Email</label>
                            <input
                              type="text"
                              className="form-control"
                              value={formData.father_email}
                              onChange={(e) => handleInputChange('father_email', e.target.value)}
                            />
                          </div>
                        </div>
                        <div className="col-lg-3 col-md-6">
                          <div className="mb-3">
                            <label className="form-label">Phone Number</label>
                            <input
                              type="text"
                              className="form-control"
                              value={formData.father_phone}
                              onChange={(e) => handleInputChange('father_phone', e.target.value)}
                            />
                          </div>
                        </div>
                        <div className="col-lg-3 col-md-6">
                          <div className="mb-3">
                            <label className="form-label">
                              Father Occupation
                            </label>
                            <input
                              type="text"
                              className="form-control"
                              value={formData.father_occupation}
                              onChange={(e) => handleInputChange('father_occupation', e.target.value)}
                            />
                          </div>
                        </div>
                      </div>
                    </div>
                    <div className="border-bottom mb-3">
                      <h5 className="mb-3">Motherâ€™s Info</h5>
                      <div className="row">
                        <div className="col-md-12">
                          <div className="d-flex align-items-center flex-wrap row-gap-3 mb-3">
                            <div className="d-flex align-items-center justify-content-center avatar avatar-xxl border border-dashed me-2 flex-shrink-0 text-dark frames">
                              <i className="ti ti-photo-plus fs-16" />
                            </div>
                            <div className="profile-upload">
                              <div className="profile-uploader d-flex align-items-center">
                                <div className="drag-upload-btn mb-3">
                                  Upload
                                  <input
                                    type="file"
                                    className="form-control image-sign"
                                    multiple
                                  />
                                </div>
                                <Link to="#" className="btn btn-primary mb-3">
                                  Remove
                                </Link>
                              </div>
                              <p className="fs-12">
                                Upload image size 4MB, Format JPG, PNG, SVG
                              </p>
                            </div>
                          </div>
                        </div>
                        <div className="col-lg-3 col-md-6">
                          <div className="mb-3">
                            <label className="form-label">Mother Name</label>
                            <input
                              type="text"
                              className="form-control"
                              value={formData.mother_name}
                              onChange={(e) => handleInputChange('mother_name', e.target.value)}
                            />
                          </div>
                        </div>
                        <div className="col-lg-3 col-md-6">
                          <div className="mb-3">
                            <label className="form-label">Email</label>
                            <input
                              type="text"
                              className="form-control"
                              value={formData.mother_email}
                              onChange={(e) => handleInputChange('mother_email', e.target.value)}
                            />
                          </div>
                        </div>
                        <div className="col-lg-3 col-md-6">
                          <div className="mb-3">
                            <label className="form-label">Phone Number</label>
                            <input
                              type="text"
                              className="form-control"
                              value={formData.mother_phone}
                              onChange={(e) => handleInputChange('mother_phone', e.target.value)}
                            />
                          </div>
                        </div>
                        <div className="col-lg-3 col-md-6">
                          <div className="mb-3">
                            <label className="form-label">
                              Mother Occupation
                            </label>
                            <input
                              type="text"
                              className="form-control"
                              value={formData.mother_occupation}
                              onChange={(e) => handleInputChange('mother_occupation', e.target.value)}
                            />
                          </div>
                        </div>
                      </div>
                    </div>
                    <div>
                      <h5 className="mb-3">Guardian Details</h5>
                      <div className="row">
                        <div className="col-md-12">
                          <div className="mb-2">
                            <div className="d-flex align-items-center flex-wrap">
                              <label className="form-label text-dark fw-normal me-2">
                                If Guardian Is
                              </label>
                              <div className="form-check me-3 mb-2">
                                <input
                                  className="form-check-input"
                                  type="radio"
                                  name="guardian"
                                  id="parents"
                                  defaultChecked
                                />
                                <label
                                  className="form-check-label"
                                  htmlFor="parents"
                                >
                                  Parents
                                </label>
                              </div>
                              <div className="form-check me-3 mb-2">
                                <input
                                  className="form-check-input"
                                  type="radio"
                                  name="guardian"
                                  id="guardian"
                                />
                                <label
                                  className="form-check-label"
                                  htmlFor="guardian"
                                >
                                  Guardian
                                </label>
                              </div>
                              <div className="form-check mb-2">
                                <input
                                  className="form-check-input"
                                  type="radio"
                                  name="guardian"
                                  id="other"
                                />
                                <label
                                  className="form-check-label"
                                  htmlFor="other"
                                >
                                  Others
                                </label>
                              </div>
                            </div>
                          </div>
                          <div className="d-flex align-items-center flex-wrap row-gap-3 mb-3">
                            <div className="d-flex align-items-center justify-content-center avatar avatar-xxl border border-dashed me-2 flex-shrink-0 text-dark frames">
                              <i className="ti ti-photo-plus fs-16" />
                            </div>
                            <div className="profile-upload">
                              <div className="profile-uploader d-flex align-items-center">
                                <div className="drag-upload-btn mb-3">
                                  Upload
                                  <input
                                    type="file"
                                    className="form-control image-sign"
                                    multiple
                                  />
                                </div>
                                <Link to="#" className="btn btn-primary mb-3">
                                  Remove
                                </Link>
                              </div>
                              <p className="fs-12">
                                Upload image size 4MB, Format JPG, PNG, SVG
                              </p>
                            </div>
                          </div>
                        </div>
                        <div className="col-lg-3 col-md-6">
                          <div className="mb-3">
                            <label className="form-label">Guardian Name</label>
                            <input
                              type="text"
                              className="form-control"
                              value={[formData.guardian_first_name, formData.guardian_last_name].filter(Boolean).join(' ')}
                              onChange={(e) => {
                                const v = e.target.value;
                                const idx = v.trim().indexOf(' ');
                                setFormData(prev => ({
                                  ...prev,
                                  guardian_first_name: idx >= 0 ? v.slice(0, idx).trim() : v.trim(),
                                  guardian_last_name: idx >= 0 ? v.slice(idx + 1).trim() : ''
                                }));
                              }}
                            />
                          </div>
                        </div>
                        <div className="col-lg-3 col-md-6">
                          <div className="mb-3">
                            <label className="form-label">
                              Guardian Relation
                            </label>
                            <input
                              type="text"
                              className="form-control"
                              value={formData.guardian_relation || ''}
                              onChange={(e) => handleInputChange('guardian_relation', e.target.value)}
                            />
                          </div>
                        </div>
                        <div className="col-lg-3 col-md-6">
                          <div className="mb-3">
                            <label className="form-label">Phone Number</label>
                            <input
                              type="text"
                              className="form-control"
                              value={formData.guardian_phone || ''}
                              onChange={(e) => handleInputChange('guardian_phone', e.target.value)}
                            />
                          </div>
                        </div>
                        <div className="col-lg-3 col-md-6">
                          <div className="mb-3">
                            <label className="form-label">Email</label>
                            <input
                              type="email"
                              className="form-control"
                              value={formData.guardian_email || ''}
                              onChange={(e) => handleInputChange('guardian_email', e.target.value)}
                            />
                          </div>
                        </div>
                        <div className="col-lg-3 col-md-6">
                          <div className="mb-3">
                            <label className="form-label">Occupation</label>
                            <input
                              type="text"
                              className="form-control"
                              value={formData.guardian_occupation || ''}
                              onChange={(e) => handleInputChange('guardian_occupation', e.target.value)}
                            />
                          </div>
                        </div>
                        <div className="col-lg-3 col-md-6">
                          <div className="mb-3">
                            <label className="form-label">Address</label>
                            <input
                              type="text"
                              className="form-control"
                              value={formData.guardian_address || ''}
                              onChange={(e) => handleInputChange('guardian_address', e.target.value)}
                            />
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                {/* /Parents & Guardian Information */}
                {/* Sibilings */}
                <div className="card">
                  <div className="card-header bg-light">
                    <div className="d-flex align-items-center">
                      <span className="bg-white avatar avatar-sm me-2 text-gray-7 flex-shrink-0">
                        <i className="ti ti-users fs-16" />
                      </span>
                      <h4 className="text-dark">Sibilings</h4>
                    </div>
                  </div>
                  <div className="card-body">
                    <div className="addsibling-info">
                      <div className="row">
                        <div className="col-md-12">
                          <div className="mb-2">
                            <label className="form-label">Sibling Info</label>
                            <div className="d-flex align-items-center flex-wrap">
                              <label className="form-label text-dark fw-normal me-2">
                                Is Sibling studying in the same school
                              </label>
                              <div className="form-check me-3 mb-2">
                                <input
                                  className="form-check-input"
                                  type="radio"
                                  name="sibling"
                                  id="yes"
                                  defaultChecked
                                />
                                <label
                                  className="form-check-label"
                                  htmlFor="yes"
                                >
                                  Yes
                                </label>
                              </div>
                              <div className="form-check mb-2">
                                <input
                                  className="form-check-input"
                                  type="radio"
                                  name="sibling"
                                  id="no"
                                />
                                <label
                                  className="form-check-label"
                                  htmlFor="no"
                                >
                                  No
                                </label>
                              </div>
                            </div>
                          </div>
                        </div>
                        {newContents.map((_, index) => {
                          const useRealData = isEdit && (index === 0 || index === 1);
                          return (
                          <div key={index} className="col-lg-12">
                            <div className="row">
                              <div className="col-lg-3 col-md-6">
                                <div className="mb-3">
                                  <label className="form-label">Name</label>
                                  {useRealData ? (
                                    <input
                                      type="text"
                                      className="form-control"
                                      value={index === 0 ? (formData.sibiling_1 || '') : (formData.sibiling_2 || '')}
                                      onChange={(e) => handleInputChange(index === 0 ? 'sibiling_1' : 'sibiling_2', e.target.value)}
                                    />
                                  ) : (
                                    <CommonSelect
                                      className="select"
                                      options={names}
                                      defaultValue={undefined}
                                    />
                                  )}
                                </div>
                              </div>
                              <div className="col-lg-3 col-md-6">
                                <div className="mb-3">
                                  <label className="form-label">Roll No</label>
                                  <CommonSelect
                                    className="select"
                                    options={rollno}
                                    defaultValue={undefined}
                                  />
                                </div>
                              </div>
                              <div className="col-lg-3 col-md-6">
                                <div className="mb-3">
                                  <label className="form-label">
                                    Admission No
                                  </label>
                                  <CommonSelect
                                    className="select"
                                    options={AdmissionNo}
                                    defaultValue={undefined}
                                  />
                                </div>
                              </div>
                              <div className="col-lg-3 col-md-6">
                                <div className="mb-3">
                                  <div className="d-flex align-items-center">
                                    <div className="w-100">
                                      <label className="form-label">
                                        Class
                                      </label>
                                      {useRealData ? (
                                        <input
                                          type="text"
                                          className="form-control"
                                          value={index === 0 ? (formData.sibiling_1_class || '') : (formData.sibiling_2_class || '')}
                                          onChange={(e) => handleInputChange(index === 0 ? 'sibiling_1_class' : 'sibiling_2_class', e.target.value)}
                                        />
                                      ) : (
                                        <CommonSelect
                                          className="select"
                                          options={allClass}
                                          defaultValue={undefined}
                                        />
                                      )}
                                    </div>
                                    {newContents.length > 1 && (
                                      <div>
                                        <label className="form-label">
                                          &nbsp;
                                        </label>
                                        <Link
                                          to="#"
                                          className="trash-icon ms-3"
                                          onClick={() => removeContent(index)}
                                        >
                                          <i className="ti ti-trash-x" />
                                        </Link>
                                      </div>
                                    )}
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                          );
                        })}
                      </div>
                    </div>
                    <div className="border-top pt-3">
                      <Link
                        to="#"
                        onClick={addNewContent}
                        className="add-sibling btn btn-primary d-inline-flex align-items-center"
                      >
                        <i className="ti ti-circle-plus me-2" />
                        Add New
                      </Link>
                    </div>
                  </div>
                </div>
                {/* /Sibilings */}
                {/* Address */}
                <div className="card">
                  <div className="card-header bg-light">
                    <div className="d-flex align-items-center">
                      <span className="bg-white avatar avatar-sm me-2 text-gray-7 flex-shrink-0">
                        <i className="ti ti-map fs-16" />
                      </span>
                      <h4 className="text-dark">Address</h4>
                    </div>
                  </div>
                  <div className="card-body pb-1">
                    <div className="row">
                      <div className="col-md-6">
                        <div className="mb-3">
                          <label className="form-label">Current Address</label>
                          <input
                            type="text"
                            className="form-control"
                            value={formData.current_address || ''}
                            onChange={(e) => handleInputChange('current_address', e.target.value)}
                            placeholder="Enter current address"
                          />
                        </div>
                      </div>
                      <div className="col-md-6">
                        <div className="mb-3">
                          <label className="form-label">
                            Permanent Address
                          </label>
                          <input
                            type="text"
                            className="form-control"
                            value={formData.permanent_address || ''}
                            onChange={(e) => handleInputChange('permanent_address', e.target.value)}
                            placeholder="Enter permanent address"
                          />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                {/* /Address */}
                {/* Transport Information */}
                <div className="card">
                  <div className="card-header bg-light d-flex align-items-center justify-content-between">
                    <div className="d-flex align-items-center">
                      <span className="bg-white avatar avatar-sm me-2 text-gray-7 flex-shrink-0">
                        <i className="ti ti-bus-stop fs-16" />
                      </span>
                      <h4 className="text-dark">Transport Information</h4>
                    </div>
                    <div className="form-check form-switch">
                      <input
                        className="form-check-input"
                        type="checkbox"
                        role="switch"
                        checked={formData.is_transport_required}
                        onChange={(e) => handleInputChange('is_transport_required', e.target.checked)}
                      />
                    </div>
                  </div>
                  <div className="card-body pb-1">
                    <div className="row">
                      <div className="col-lg-4 col-md-6">
                        <div className="mb-3">
                          <label className="form-label">Route</label>
                          <CommonSelect
                            className="select"
                            options={formData.route_name && !route.find(o => o.value === formData.route_name) ? [{ value: formData.route_name, label: formData.route_name }, ...route] : route}
                            value={formData.route_name || null}
                            onChange={(v) => handleInputChange('route_name', v || '')}
                          />
                        </div>
                      </div>
                      <div className="col-lg-4 col-md-6">
                        <div className="mb-3">
                          <label className="form-label">Vehicle Number</label>
                          <CommonSelect
                            className="select"
                            options={formData.vehicle_number && !VehicleNumber.find(o => o.value === formData.vehicle_number) ? [{ value: formData.vehicle_number, label: formData.vehicle_number }, ...VehicleNumber] : VehicleNumber}
                            value={formData.vehicle_number || null}
                            onChange={(v) => handleInputChange('vehicle_number', v || '')}
                          />
                        </div>
                      </div>
                      <div className="col-lg-4 col-md-6">
                        <div className="mb-3">
                          <label className="form-label">Pickup Point</label>
                          <CommonSelect
                            className="select"
                            options={formData.pickup_point_name && !PickupPoint.find(o => o.value === formData.pickup_point_name) ? [{ value: formData.pickup_point_name, label: formData.pickup_point_name }, ...PickupPoint] : PickupPoint}
                            value={formData.pickup_point_name || null}
                            onChange={(v) => handleInputChange('pickup_point_name', v || '')}
                          />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                {/* /Transport Information */}
                {/* Hostel Information */}
                <div className="card">
                  <div className="card-header bg-light d-flex align-items-center justify-content-between">
                    <div className="d-flex align-items-center">
                      <span className="bg-white avatar avatar-sm me-2 text-gray-7 flex-shrink-0">
                        <i className="ti ti-building-fortress fs-16" />
                      </span>
                      <h4 className="text-dark">Hostel Information</h4>
                    </div>
                    <div className="form-check form-switch">
                      <input
                        className="form-check-input"
                        type="checkbox"
                        role="switch"
                        checked={formData.is_hostel_required}
                        onChange={(e) => handleInputChange('is_hostel_required', e.target.checked)}
                      />
                    </div>
                  </div>
                  <div className="card-body pb-1">
                    <div className="row">
                      <div className="col-md-6">
                        <div className="mb-3">
                          <label className="form-label">Hostel</label>
                          <CommonSelect
                            className="select"
                            options={
                              formData.hostel_id && !hostelOptions.find(o => o.value === formData.hostel_id)
                                ? [{ value: formData.hostel_id, label: formData.hostel_name || formData.hostel_id }, ...hostelOptions]
                                : hostelOptions.length > 0 ? hostelOptions : [{ value: "", label: "No hostels" }]
                            }
                            value={formData.hostel_id || null}
                            onChange={(v) => {
                              const opt = hostelOptions.find(o => o.value === v);
                              setFormData(prev => ({
                                ...prev,
                                hostel_id: v || null,
                                hostel_name: opt?.label ?? "",
                              }));
                            }}
                          />
                        </div>
                      </div>
                      <div className="col-md-6">
                        <div className="mb-3">
                          <label className="form-label">Room No</label>
                          <CommonSelect
                            className="select"
                            options={
                              formData.hostel_room_id && !roomOptions.find(o => o.value === formData.hostel_room_id)
                                ? [{ value: formData.hostel_room_id, label: formData.hostel_room_number || formData.hostel_room_id }, ...roomOptions]
                                : roomOptions.length > 0 ? roomOptions : [{ value: "", label: "No rooms" }]
                            }
                            value={formData.hostel_room_id || null}
                            onChange={(v) => {
                              const opt = roomOptions.find(o => o.value === v);
                              setFormData(prev => ({
                                ...prev,
                                hostel_room_id: v || null,
                                hostel_room_number: opt?.label ?? "",
                              }));
                            }}
                          />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                {/* /Hostel Information */}
                {/* Documents */}
                <div className="card">
                  <div className="card-header bg-light">
                    <div className="d-flex align-items-center">
                      <span className="bg-white avatar avatar-sm me-2 text-gray-7 flex-shrink-0">
                        <i className="ti ti-file fs-16" />
                      </span>
                      <h4 className="text-dark">Documents</h4>
                    </div>
                  </div>
                  <div className="card-body pb-1">
                    <div className="row">
                      <div className="col-lg-6">
                        <div className="mb-2">
                          <div className="mb-3">
                            <label className="form-label mb-1">
                              Medical Condition
                            </label>
                            <p>Upload image size of 4MB, Accepted Format PDF</p>
                          </div>
                          <div className="d-flex align-items-center flex-wrap">
                            <div className="btn btn-primary drag-upload-btn mb-2 me-2">
                              <i className="ti ti-file-upload me-1" />
                              Change
                              <input
                                type="file"
                                className="form-control image_sign"
                                multiple
                              />
                            </div>
                            {isEdit ? (
                              <p className="mb-2">BirthCertificate.pdf</p>
                            ) : (
                              <></>
                            )}
                          </div>
                        </div>
                      </div>
                      <div className="col-lg-6">
                        <div className="mb-2">
                          <div className="mb-3">
                            <label className="form-label mb-1">
                              Upload Transfer Certificate
                            </label>
                            <p>Upload image size of 4MB, Accepted Format PDF</p>
                          </div>
                          <div className="d-flex align-items-center flex-wrap">
                            <div className="btn btn-primary drag-upload-btn mb-2">
                              <i className="ti ti-file-upload me-1" />
                              Upload Document
                              <input
                                type="file"
                                className="form-control image_sign"
                                multiple
                              />
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                {/* /Documents */}
                {/* Medical History */}
                <div className="card">
                  <div className="card-header bg-light">
                    <div className="d-flex align-items-center">
                      <span className="bg-white avatar avatar-sm me-2 text-gray-7 flex-shrink-0">
                        <i className="ti ti-medical-cross fs-16" />
                      </span>
                      <h4 className="text-dark">Medical History</h4>
                    </div>
                  </div>
                  <div className="card-body pb-1">
                    <div className="row">
                      <div className="col-md-12">
                        <div className="mb-2">
                          <label className="form-label">
                            Medical Condition
                          </label>
                          <div className="d-flex align-items-center flex-wrap">
                            <label className="form-label text-dark fw-normal me-2">
                              Medical Condition of a Student
                            </label>
                            <div className="form-check me-3 mb-2">
                              <input
                                className="form-check-input"
                                type="radio"
                                name="condition"
                                id="good"
                                checked={formData.medical_condition === 'Good'}
                                onChange={() => handleInputChange('medical_condition', 'Good')}
                              />
                              <label
                                className="form-check-label"
                                htmlFor="good"
                              >
                                Good
                              </label>
                            </div>
                            <div className="form-check me-3 mb-2">
                              <input
                                className="form-check-input"
                                type="radio"
                                name="condition"
                                id="bad"
                                checked={formData.medical_condition === 'Bad'}
                                onChange={() => handleInputChange('medical_condition', 'Bad')}
                              />
                              <label className="form-check-label" htmlFor="bad">
                                Bad
                              </label>
                            </div>
                            <div className="form-check mb-2">
                              <input
                                className="form-check-input"
                                type="radio"
                                name="condition"
                                id="others"
                                checked={formData.medical_condition === 'Others'}
                                onChange={() => handleInputChange('medical_condition', 'Others')}
                              />
                              <label
                                className="form-check-label"
                                htmlFor="others"
                              >
                                Others
                              </label>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div className="mb-3">
                        <label className="form-label">Allergies</label>

                        <TagInput
                          initialTags={owner1}
                          onTagsChange={handleTagsChange3}
                        />
                      </div>
                      <div className="mb-3">
                        <label className="form-label">Medications</label>
                        <TagInput
                          initialTags={owner2}
                          onTagsChange={handleTagsChange4}
                        />
                      </div>
                    </div>
                  </div>
                </div>
                {/* /Medical History */}
                {/* Previous School details */}
                <div className="card">
                  <div className="card-header bg-light">
                    <div className="d-flex align-items-center">
                      <span className="bg-white avatar avatar-sm me-2 text-gray-7 flex-shrink-0">
                        <i className="ti ti-building fs-16" />
                      </span>
                      <h4 className="text-dark">Previous School Details</h4>
                    </div>
                  </div>
                  <div className="card-body pb-1">
                    <div className="row">
                      <div className="col-md-6">
                        <div className="mb-3">
                          <label className="form-label">School Name</label>
                          <input
                            type="text"
                            className="form-control"
                            value={formData.previous_school || ''}
                            onChange={(e) => handleInputChange('previous_school', e.target.value)}
                          />
                        </div>
                      </div>
                      <div className="col-md-6">
                        <div className="mb-3">
                          <label className="form-label">Address</label>
                          <input
                            type="text"
                            className="form-control"
                            value={formData.previous_school_address || ''}
                            onChange={(e) => handleInputChange('previous_school_address', e.target.value)}
                          />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                {/* /Previous School details */}
                {/* Other Details */}
                <div className="card">
                  <div className="card-header bg-light">
                    <div className="d-flex align-items-center">
                      <span className="bg-white avatar avatar-sm me-2 text-gray-7 flex-shrink-0">
                        <i className="ti ti-building-bank fs-16" />
                      </span>
                      <h4 className="text-dark">Other Details</h4>
                    </div>
                  </div>
                  <div className="card-body pb-1">
                    <div className="row">
                      <div className="col-md-5">
                        <div className="mb-3">
                          <label className="form-label">Bank Name</label>
                          <input
                            type="text"
                            className="form-control"
                            value={formData.bank_name || ''}
                            onChange={(e) => handleInputChange('bank_name', e.target.value)}
                          />
                        </div>
                      </div>
                      <div className="col-md-2">
                        <div className="mb-3">
                          <label className="form-label">Branch</label>
                          <input
                            type="text"
                            className="form-control"
                            value={formData.branch || ''}
                            onChange={(e) => handleInputChange('branch', e.target.value)}
                          />
                        </div>
                      </div>
                      <div className="col-md-5">
                        <div className="mb-3">
                          <label className="form-label">IFSC Number</label>
                          <input
                            type="text"
                            className="form-control"
                            value={formData.ifsc || ''}
                            onChange={(e) => handleInputChange('ifsc', e.target.value)}
                          />
                        </div>
                      </div>
                      <div className="col-md-12">
                        <div className="mb-3">
                          <label className="form-label">
                            Other Information
                          </label>
                          <textarea
                            className="form-control"
                            rows={3}
                            value={formData.other_information || ''}
                            onChange={(e) => handleInputChange('other_information', e.target.value)}
                          />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                {/* /Other Details */}
                <div className="text-end">
                  <button type="button" className="btn btn-light me-3">
                    Cancel
                  </button>
                  <button type="submit" className="btn btn-primary" disabled={isSubmitting}>
                    {isSubmitting ? (isEdit ? 'Updating...' : 'Adding...') : (isEdit ? 'Update Student' : 'Add Student')}
                  </button>
                </div>
              </form>
            </div>
          </div>
          )}
        </div>
      </div>
      {/* /Page Wrapper */}
    </>
  );
};

export default AddStudent;
