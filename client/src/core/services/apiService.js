const BUILD_API_URL = import.meta.env.VITE_API_URL || 'http://localhost:5000/api';
const isDev = import.meta.env.DEV;
const isProd = import.meta.env.PROD;
const TOKEN_KEY = 'preskool_token';

let cachedBaseUrl = null;

async function getApiBaseUrl() {
  if (cachedBaseUrl) return cachedBaseUrl;
  if (!isProd) {
    cachedBaseUrl = BUILD_API_URL;
    return cachedBaseUrl;
  }
  try {
    const res = await fetch('/config.json', { cache: 'no-store' });
    if (res.ok) {
      const config = await res.json();
      if (config && config.apiUrl) {
        cachedBaseUrl = config.apiUrl.replace(/\/+$/, '');
        if (!cachedBaseUrl.endsWith('/api')) cachedBaseUrl += '/api';
        return cachedBaseUrl;
      }
    }
  } catch (_) {}
  cachedBaseUrl = BUILD_API_URL;
  return cachedBaseUrl;
}

const getToken = () => localStorage.getItem(TOKEN_KEY);

// Request deduplication: track ongoing requests to prevent duplicate simultaneous calls
const pendingRequests = new Map();

class ApiService {
  async makeRequest(endpoint, options = {}) {
    const base = await getApiBaseUrl();
    const url = `${base}${endpoint.startsWith('/') ? '' : '/'}${endpoint}`;
    
    // Create a unique key for this request (endpoint + method + body hash)
    const method = options.method || 'GET';
    const bodyKey = options.body ? JSON.stringify(options.body).substring(0, 50) : '';
    const requestKey = `${method}:${endpoint}:${bodyKey}`;
    
    // If the same request is already pending, return the existing promise
    if (pendingRequests.has(requestKey)) {
      if (isDev) console.log('Deduplicating request:', url, '- reusing pending request');
      return pendingRequests.get(requestKey);
    }
    
    if (isDev) console.log('Making API request to:', url);
    
    // Create the request promise
    const requestPromise = this._executeRequest(url, options)
      .finally(() => {
        // Remove from pending requests when done (success or error)
        pendingRequests.delete(requestKey);
      });
    
    // Store the pending request
    pendingRequests.set(requestKey, requestPromise);
    
    return requestPromise;
  }
  
  async _executeRequest(url, options = {}) {

    const headers = {
      'Content-Type': 'application/json',
      'Accept': 'application/json',
      ...(options.headers || {}),
    };

    const token = getToken();
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    try {
      const response = await fetch(url, {
        method: 'GET',
        headers,
        mode: 'cors',
        credentials: 'omit',
        ...options,
      });

      if (isDev) {
        console.log('Response status:', response.status);
      }

      if (!response.ok) {
        if (response.status === 401) {
          localStorage.removeItem(TOKEN_KEY);
          localStorage.removeItem('preskool_user');
          window.dispatchEvent(new CustomEvent('auth:sessionExpired'));
        }
        // Handle rate limiting (429) specifically
        if (response.status === 429) {
          const errorText = await response.text();
          if (isDev) console.error('Rate limit exceeded:', errorText);
          // Don't throw immediately - wait a bit and let deduplication handle retries
          throw new Error(`Rate limit exceeded. Please wait a moment before trying again.`);
        }
        const errorText = await response.text();
        if (isDev) console.error('Response error text:', errorText);
        throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
      }

      const text = await response.text();
      if (!text || !text.trim()) {
        throw new Error('Server returned empty response. Check that the API URL is correct and CORS is configured for this site.');
      }
      let data;
      try {
        data = JSON.parse(text);
      } catch (_) {
        throw new Error('Server returned invalid JSON. Check API URL and backend logs.');
      }
      if (isDev) console.log('Response data:', data);
      return data;
    } catch (error) {
      if (isDev) {
        console.error('API request failed:', error);
      }
      throw error;
    }
  }
  
  // Academic Years
  async getAcademicYears() {
    return this.makeRequest('/academic-years');
  }

  async getAcademicYearById(id) {
    return this.makeRequest(`/academic-years/${id}`);
  }

  // Classes
  async getClasses() {
    return this.makeRequest('/classes');
  }

  async getClassById(id) {
    return this.makeRequest(`/classes/${id}`);
  }

  async getClassesByAcademicYear(academicYearId) {
    return this.makeRequest(`/classes/academic-year/${academicYearId}`);
  }

  async updateClass(id, classData) {
    return this.makeRequest(`/classes/${id}`, {
      method: 'PUT',
      body: JSON.stringify(classData)
    });
  }

  // Sections
  async getSections() {
    return this.makeRequest('/sections');
  }

  async getSectionById(id) {
    return this.makeRequest(`/sections/${id}`);
  }

  async getSectionsByClass(classId) {
    return this.makeRequest(`/sections/class/${classId}`);
  }

  async updateSection(id, sectionData) {
    return this.makeRequest(`/sections/${id}`, {
      method: 'PUT',
      body: JSON.stringify(sectionData)
    });
  }

  // Class Rooms
  async getClassRooms() {
    return this.makeRequest('/class-rooms');
  }

  async getClassRoomById(id) {
    return this.makeRequest(`/class-rooms/${id}`);
  }

  async createClassRoom(data) {
    return this.makeRequest('/class-rooms', {
      method: 'POST',
      body: JSON.stringify(data)
    });
  }

  async updateClassRoom(id, data) {
    return this.makeRequest(`/class-rooms/${id}`, {
      method: 'PUT',
      body: JSON.stringify(data)
    });
  }

  async deleteClassRoom(id) {
    return this.makeRequest(`/class-rooms/${id}`, {
      method: 'DELETE'
    });
  }

  // Class schedules (timetable: class + subject + time_slot)
  async getClassSchedules() {
    return this.makeRequest('/class-schedules');
  }

  async getClassScheduleById(id) {
    return this.makeRequest(`/class-schedules/${id}`);
  }

  // Schedules (time_slots / schedule table - ID, Type, Start Time, End Time, Status)
  async getSchedules() {
    return this.makeRequest('/schedules');
  }

  async getScheduleById(id) {
    return this.makeRequest(`/schedules/${id}`);
  }

  async updateSchedule(id, scheduleData) {
    return this.makeRequest(`/schedules/${id}`, {
      method: 'PUT',
      body: JSON.stringify(scheduleData)
    });
  }

  // Students
  async getStudents() {
    return this.makeRequest('/students');
  }

  async createStudent(studentData) {
    return this.makeRequest('/students', {
      method: 'POST',
      body: JSON.stringify(studentData)
    });
  }

  async updateStudent(id, studentData) {
    return this.makeRequest(`/students/${id}`, {
      method: 'PUT',
      body: JSON.stringify(studentData)
    });
  }

  async getStudentById(id) {
    return this.makeRequest(`/students/${id}`);
  }

  async getStudentsByClass(classId) {
    return this.makeRequest(`/students/class/${classId}`);
  }

  // Blood Groups
  async getBloodGroups() {
    return this.makeRequest('/blood-groups');
  }

  async getBloodGroupById(id) {
    return this.makeRequest(`/blood-groups/${id}`);
  }

  // Religions
  async getReligions() {
    return this.makeRequest('/religions');
  }

  async getReligionById(id) {
    return this.makeRequest(`/religions/${id}`);
  }

  // Casts
  async getCasts() {
    return this.makeRequest('/casts');
  }

  async getCastById(id) {
    return this.makeRequest(`/casts/${id}`);
  }

  // Mother Tongues
  async getMotherTongues() {
    return this.makeRequest('/mother-tongues');
  }

  async getMotherTongueById(id) {
    return this.makeRequest(`/mother-tongues/${id}`);
  }

  // Houses
  async getHouses() {
    return this.makeRequest('/houses');
  }

  async getHouseById(id) {
    return this.makeRequest(`/houses/${id}`);
  }

  // Parents
  async getParents() {
    return this.makeRequest('/parents');
  }

  async getParentById(id) {
    return this.makeRequest(`/parents/${id}`);
  }

  async getParentByStudentId(studentId) {
    return this.makeRequest(`/parents/student/${studentId}`);
  }

  async createParent(parentData) {
    return this.makeRequest('/parents', {
      method: 'POST',
      body: JSON.stringify(parentData)
    });
  }

  async updateParent(id, parentData) {
    return this.makeRequest(`/parents/${id}`, {
      method: 'PUT',
      body: JSON.stringify(parentData)
    });
  }

  // Guardians
  async getGuardians() {
    return this.makeRequest('/guardians');
  }

  async getGuardianById(id) {
    return this.makeRequest(`/guardians/${id}`);
  }

  async getGuardianByStudentId(studentId) {
    return this.makeRequest(`/guardians/student/${studentId}`);
  }

  // Teachers
  async getTeachers() {
    return this.makeRequest('/teachers');
  }

  async getTeacherById(id) {
    return this.makeRequest(`/teachers/${id}`);
  }

  async getTeachersByClass(classId) {
    return this.makeRequest(`/teachers/class/${classId}`);
  }

  async getTeacherRoutine(teacherId) {
    return this.makeRequest(`/teachers/${teacherId}/routine`);
  }

  async updateTeacher(id, teacherData) {
    return this.makeRequest(`/teachers/${id}`, {
      method: 'PUT',
      body: JSON.stringify(teacherData)
    });
  }

  // Staff
  async getStaff() {
    return this.makeRequest('/staff');
  }

  async getStaffById(id) {
    return this.makeRequest(`/staff/${id}`);
  }

  // Departments
  async getDepartments() {
    return this.makeRequest('/departments');
  }

  async getDepartmentById(id) {
    return this.makeRequest(`/departments/${id}`);
  }

  async updateDepartment(id, departmentData) {
    return this.makeRequest(`/departments/${id}`, {
      method: 'PUT',
      body: JSON.stringify(departmentData),
    });
  }

  // Designations
  async getDesignations() {
    return this.makeRequest('/designations');
  }

  async getDesignationById(id) {
    return this.makeRequest(`/designations/${id}`);
  }

  async updateDesignation(id, designationData) {
    return this.makeRequest(`/designations/${id}`, {
      method: 'PUT',
      body: JSON.stringify(designationData),
    });
  }

  // Users
  async getUsers() {
    return this.makeRequest('/users');
  }

  async getUserById(id) {
    return this.makeRequest(`/users/${id}`);
  }

  // User Roles
  async getUserRoles() {
    return this.makeRequest('/user-roles');
  }

  async getUserRoleById(id) {
    return this.makeRequest(`/user-roles/${id}`);
  }

  // Dashboard stats
  async getDashboardStats() {
    return this.makeRequest('/dashboard/stats');
  }

  async getLeaveApplications(params = {}) {
    const searchParams = new URLSearchParams();
    if (params.limit != null) searchParams.set('limit', params.limit);
    const qs = searchParams.toString();
    return this.makeRequest(`/leave-applications${qs ? `?${qs}` : ''}`);
  }

  // Transport
  async getTransportRoutes() {
    return this.makeRequest('/transport/routes');
  }

  async getTransportRouteById(id) {
    return this.makeRequest(`/transport/routes/${id}`);
  }

  async updateTransportRoute(id, routeData) {
    return this.makeRequest(`/transport/routes/${id}`, {
      method: 'PUT',
      body: JSON.stringify(routeData)
    });
  }

  async updateTransportPickupPoint(id, pickupData) {
    return this.makeRequest(`/transport/pickup-points/${id}`, {
      method: 'PUT',
      body: JSON.stringify(pickupData)
    });
  }

  async updateTransportVehicle(id, vehicleData) {
    return this.makeRequest(`/transport/vehicles/${id}`, {
      method: 'PUT',
      body: JSON.stringify(vehicleData)
    });
  }

  async updateTransportDriver(id, driverData) {
    return this.makeRequest(`/transport/drivers/${id}`, {
      method: 'PUT',
      body: JSON.stringify(driverData)
    });
  }

  async getTransportPickupPoints() {
    return this.makeRequest('/transport/pickup-points');
  }

  async getTransportPickupPointById(id) {
    return this.makeRequest(`/transport/pickup-points/${id}`);
  }

  async getTransportVehicles() {
    return this.makeRequest('/transport/vehicles');
  }

  async getTransportVehicleById(id) {
    return this.makeRequest(`/transport/vehicles/${id}`);
  }

  async getTransportDrivers() {
    return this.makeRequest('/transport/drivers');
  }

  async getTransportDriverById(id) {
    return this.makeRequest(`/transport/drivers/${id}`);
  }

  // Subjects
  async getSubjects() {
    return this.makeRequest('/subjects');
  }

  async getSubjectById(id) {
    return this.makeRequest(`/subjects/${id}`);
  }

  async getSubjectsByClass(classId) {
    return this.makeRequest(`/subjects/class/${classId}`);
  }

  async updateSubject(id, subjectData) {
    return this.makeRequest(`/subjects/${id}`, {
      method: 'PUT',
      body: JSON.stringify(subjectData),
    });
  }

  // Hostels
  async getHostels() {
    return this.makeRequest('/hostels');
  }

  async getHostelById(id) {
    return this.makeRequest(`/hostels/${id}`);
  }

  // Hostel Rooms
  async getHostelRooms() {
    return this.makeRequest('/hostel-rooms');
  }

  async getHostelRoomById(id) {
    return this.makeRequest(`/hostel-rooms/${id}`);
  }

   async updateHostelRoom(id, roomData) {
    return this.makeRequest(`/hostel-rooms/${id}`, {
      method: 'PUT',
      body: JSON.stringify(roomData),
    });
  }

  // Room Types
  async getRoomTypes() {
    return this.makeRequest('/room-types');
  }

  async getRoomTypeById(id) {
    return this.makeRequest(`/room-types/${id}`);
  }

  // Health check
  async getHealthStatus() {
    return this.makeRequest('/health');
  }

  // Auth
  async login(username, password) {
    return this.makeRequest('/auth/login', {
      method: 'POST',
      body: JSON.stringify({ username, password }),
    });
  }

  async getMe() {
    return this.makeRequest('/auth/me');
  }

  // Chats
  async getChats() {
    return this.makeRequest('/chats');
  }

  async getConversations() {
    return this.makeRequest('/chats/conversations');
  }

  async getChatById(id) {
    return this.makeRequest(`/chats/${id}`);
  }

  async getChatMessages(recipientId) {
    return this.makeRequest(`/chats/messages/${recipientId}`);
  }

  async getSharedMedia(recipientId, type) {
    const qs = type ? `?type=${type}` : '';
    return this.makeRequest(`/chats/shared-media/${recipientId}${qs}`);
  }

  async createChat(data) {
    return this.makeRequest('/chats', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  }

  async updateChat(id, data) {
    return this.makeRequest(`/chats/${id}`, {
      method: 'PUT',
      body: JSON.stringify(data),
    });
  }

  async updateChatConversationPin(recipientId, isPinned) {
    return this.makeRequest(`/chats/conversation/${recipientId}/pin`, {
      method: 'PUT',
      body: JSON.stringify({ is_pinned: isPinned }),
    });
  }

  async deleteConversation(recipientId) {
    return this.makeRequest(`/chats/conversation/${recipientId}`, {
      method: 'DELETE',
    });
  }

  async muteConversation(recipientId, isMuted, mutedUntil) {
    return this.makeRequest(`/chats/conversation/${recipientId}/mute`, {
      method: 'PUT',
      body: JSON.stringify({ is_muted: isMuted, muted_until: mutedUntil }),
    });
  }

  async clearConversation(recipientId) {
    return this.makeRequest(`/chats/conversation/${recipientId}/clear`, {
      method: 'PUT',
    });
  }

  async reportUser(recipientId, reason) {
    return this.makeRequest(`/chats/conversation/${recipientId}/report`, {
      method: 'POST',
      body: JSON.stringify({ reason }),
    });
  }

  async blockUser(recipientId) {
    return this.makeRequest(`/chats/conversation/${recipientId}/block`, {
      method: 'POST',
    });
  }

  async deleteChat(id) {
    return this.makeRequest(`/chats/${id}`, {
      method: 'DELETE',
    });
  }

  // Calls
  async getCalls() {
    return this.makeRequest('/calls');
  }

  async getCallById(id) {
    return this.makeRequest(`/calls/${id}`);
  }

  async createCall(data) {
    return this.makeRequest('/calls', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  }

  async updateCall(id, data) {
    return this.makeRequest(`/calls/${id}`, {
      method: 'PUT',
      body: JSON.stringify(data),
    });
  }

  async deleteCall(id) {
    return this.makeRequest(`/calls/${id}`, {
      method: 'DELETE',
    });
  }

  // Calendar Events
  async getCalendarEvents(params = {}) {
    const queryString = new URLSearchParams(params).toString();
    return this.makeRequest(`/calendar${queryString ? `?${queryString}` : ''}`);
  }

  async getCalendarEventById(id) {
    return this.makeRequest(`/calendar/${id}`);
  }

  async createCalendarEvent(data) {
    return this.makeRequest('/calendar', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  }

  async updateCalendarEvent(id, data) {
    return this.makeRequest(`/calendar/${id}`, {
      method: 'PUT',
      body: JSON.stringify(data),
    });
  }

  async deleteCalendarEvent(id) {
    return this.makeRequest(`/calendar/${id}`, {
      method: 'DELETE',
    });
  }

  // Emails
  async getEmails(folder = 'inbox') {
    return this.makeRequest(`/emails?folder=${folder}`);
  }

  async getEmailById(id) {
    return this.makeRequest(`/emails/${id}`);
  }

  async createEmail(data) {
    return this.makeRequest('/emails', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  }

  async updateEmail(id, data) {
    return this.makeRequest(`/emails/${id}`, {
      method: 'PUT',
      body: JSON.stringify(data),
    });
  }

  async deleteEmail(id) {
    return this.makeRequest(`/emails/${id}`, {
      method: 'DELETE',
    });
  }

  // Todos
  async getTodos(params = {}) {
    const queryString = new URLSearchParams(params).toString();
    return this.makeRequest(`/todos${queryString ? `?${queryString}` : ''}`);
  }

  async getTodoById(id) {
    return this.makeRequest(`/todos/${id}`);
  }

  async createTodo(data) {
    return this.makeRequest('/todos', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  }

  async updateTodo(id, data) {
    return this.makeRequest(`/todos/${id}`, {
      method: 'PUT',
      body: JSON.stringify(data),
    });
  }

  async deleteTodo(id) {
    return this.makeRequest(`/todos/${id}`, {
      method: 'DELETE',
    });
  }

  // Notes
  async getNotes(params = {}) {
    const queryString = new URLSearchParams(params).toString();
    return this.makeRequest(`/notes${queryString ? `?${queryString}` : ''}`);
  }

  async getNoteById(id) {
    return this.makeRequest(`/notes/${id}`);
  }

  async createNote(data) {
    return this.makeRequest('/notes', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  }

  async updateNote(id, data) {
    return this.makeRequest(`/notes/${id}`, {
      method: 'PUT',
      body: JSON.stringify(data),
    });
  }

  async deleteNote(id) {
    return this.makeRequest(`/notes/${id}`, {
      method: 'DELETE',
    });
  }

  // Files
  async getFiles(params = {}) {
    const queryString = new URLSearchParams(params).toString();
    return this.makeRequest(`/files${queryString ? `?${queryString}` : ''}`);
  }

  async getFileById(id) {
    return this.makeRequest(`/files/${id}`);
  }

  async createFile(data) {
    return this.makeRequest('/files', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  }

  async updateFile(id, data) {
    return this.makeRequest(`/files/${id}`, {
      method: 'PUT',
      body: JSON.stringify(data),
    });
  }

  async deleteFile(id) {
    return this.makeRequest(`/files/${id}`, {
      method: 'DELETE',
    });
  }

  // Class Syllabus
  async getClassSyllabus() {
    return this.makeRequest('/class-syllabus');
  }

  async getClassSyllabusById(id) {
    return this.makeRequest(`/class-syllabus/${id}`);
  }

  async createClassSyllabus(data) {
    return this.makeRequest('/class-syllabus', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  }

  async updateClassSyllabus(id, data) {
    return this.makeRequest(`/class-syllabus/${id}`, {
      method: 'PUT',
      body: JSON.stringify(data),
    });
  }

  async deleteClassSyllabus(id) {
    return this.makeRequest(`/class-syllabus/${id}`, {
      method: 'DELETE',
    });
  }
}

export const apiService = new ApiService();
